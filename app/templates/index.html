<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TutorDash</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
    header { text-align: center; padding: 1em; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header h1 { margin: 0; }
    .nav-pills { margin-top: 1em; }
    .nav-pills a {
      display: inline-block;
      margin: 0 0.5em;
      padding: 0.5em 1em;
      border-radius: 20px;
      background: #eee;
      text-decoration: none;
      color: #333;
    }
    .nav-pills a.active {
      background: #3366cc;
      color: #fff;
    }
    .container { display: flex; flex-wrap: nowrap; padding: 1em; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1em; margin: 1em; }
    .upcoming-lessons { flex: 0 0 45%; }
    .lesson-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75em;
      border-bottom: 1px solid #ddd;
    }
    .lesson-info, .lesson-student-info {
      flex: 1;
    }
    .lesson-info {
      text-align: left;
    }
    .lesson-student-info {
      text-align: right;
    }
    .graph-container { flex: 0 0 45%; }
    #earningsChart { width: 100%; height: 250px; }
    .year-buttons { text-align: right; margin-bottom: 0.5em; }
    .year-button {
      margin: 0 0.25em;
      padding: 0.25em 0.5em;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .year-button.active {
      background: #3366cc;
      color: #fff;
      border-color: #3366cc;
    }
    .stats { display: flex; justify-content: space-around; margin-top: 1em; }
    .stats div { text-align: center; }
    #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
  </style>
</head>
<body>
  <header>
    <h1>TutorDash</h1>
    <div class="nav-pills">
      <a href="{{ url_for('manage_students') }}">Manage Students</a>
      <a href="{{ url_for('sync_all') }}">Sync All Lessons</a>
      <a href="{{ url_for('create_invoice') }}">Quick Invoice</a>
      <a href="{{ url_for('create_invoice') }}">Custom Invoice</a>
    </div>
  </header>

  <div class="container">
    <div class="card upcoming-lessons">
      <h2>Upcoming Lessons</h2>
      {% if upcoming_lessons %}
        {% for lesson in upcoming_lessons %}
          <div class="lesson-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="lesson-info">
              <div><strong>{{ lesson.relative }}</strong></div>
              <div style="font-size:0.9em; color:#666;">({{ lesson.actual }})</div>
              <div>{{ lesson.start_time }} - {{ lesson.end_time }}</div>
            </div>
            <div class="lesson-student-info" style="text-align:right;">
              <div style="font-weight:bold; font-size:1.1em;">{{ lesson.student.name }}</div>
              <div style="font-size:0.9em; color:#666;">
                {{ lesson.student.level }}, {{ lesson.student.year }} - {{ lesson.student.subject }} ({{ lesson.student.exam_board }})
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No upcoming lessons scheduled.</p>
      {% endif %}
    </div>

    <div class="card graph-container">
      <h2>Year-to-Date Earnings</h2>
      <div class="year-buttons">
        {% for y in available_years %}
          <button class="year-button {% if y in selected_years %}active{% endif %}" data-year="{{ y }}">{{ y }}</button>
        {% endfor %}
      </div>
      <canvas id="earningsChart"></canvas>
      <div class="stats">
        <div>
          <div><strong>&pound;{{ "{:,.2f}".format(ytd_total) }}</strong></div>
          <div>Year-to-Date</div>
        </div>
        <div>
          <div><strong>&pound;{{ "{:,.2f}".format(mtd_total) }}</strong></div>
          <div>Month-to-Date</div>
        </div>
        <div>
          <div><strong>&pound;{{ "{:,.2f}".format(total_all) }}</strong></div>
          <div>Total Earnings</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const palette = ['#3366cc', '#dc3912', '#ff9900', '#109618', '#990099'];
    const earningsData = {{ earnings_data_json | safe }};
    const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    function buildDatasets(years) {
      return years.map((year, idx) => ({
        label: year,
        data: earningsData[year] || Array(labels.length).fill(0),
        fill: false,
        borderColor: palette[idx % palette.length],
      }));
    }

    // Initialize chart
    const initialYears = Array.from(document.querySelectorAll('.year-button.active'))
                               .map(btn => btn.dataset.year);
    const ctx = document.getElementById('earningsChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: buildDatasets(initialYears),
      },
      options: {
        responsive: true,
        scales: {
          y: { title: { display: true, text: 'Earnings' } },
          x: { title: { display: true, text: 'Month' } }
        }
      }
    });

    // Year button click handler
    document.querySelectorAll('.year-button').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
        const selected = Array.from(document.querySelectorAll('.year-button.active'))
                              .map(b => b.dataset.year);
        chart.data.datasets = buildDatasets(selected);
        chart.update();
      });
    });

    {% for msg in get_flashed_messages() %}
      const toast = document.createElement('div');
      toast.innerText = "{{ msg }}";
      toast.style.cssText = 'background:#333;color:#fff;padding:10px;border-radius:4px;margin-top:5px;';
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 20000);
    {% endfor %}
  </script>
</body>
</html>